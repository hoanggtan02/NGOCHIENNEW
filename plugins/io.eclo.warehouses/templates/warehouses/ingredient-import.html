<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="text-center mb-4">
                <i class="ti ti-packages text-eclo" style="font-size: 70px;"></i>
                <h3 class="fw-bold mt-2">
                    <?=$title?>
                </h3>
                <p class="text-muted">Nhập tên hoặc mã nguyên liệu để thêm vào phiếu nhập</p>
            </div>

            <div class="w-100 position-relative" data-search="true" data-url="/api/ingredient-search">
                <input type="text" class="form-control form-control-lg rounded-pill py-3 shadow-sm border-0"
                    placeholder="Tìm kiếm nguyên liệu..." aria-label="Search ingredients">
                <div class="search-results-box rounded-4 shadow bg-body border-0 position-absolute max-height scroll-y w-100 z-3"
                    style="--max-height:300px;"></div>
                <template class="search-item-template">
                    <div class="search-item border-0 py-2 btn text-start position-relative"
                        style="display: flex; align-items: center; gap: 10px;">
                        <div>
                            <strong data-name="text"></strong><br>
                            <a data-action="click" data-alert="true" data-load="this"
                                data-selector="[ingredient-list-result]" data-attr-url="url" class="stretched-link"
                                href="#!"></a>
                        </div>
                    </div>
                </template>
            </div>


            <div class="card bg-body bg-opacity-50 shadow border-0 rounded-4 mt-4" ingredient-list-result>
                <div class="card-body p-3">
                    <div class=" d-flex justify-content-between align-items-center px-2 mb-3">
                        <h6 class=" fw-bold mb-0">Danh sách nguyên liệu trong phiếu</h6>
                          <div class="ms-3">
                            <button data-action="modal" type="button"
                                class="mt-1 btn btn-sm btn-danger text-white btn-outline-danger" data-bs-toggle="modal"
                                data-url="/warehouses/warehouse-ingredient-excel">
                                <i class="ti ti-file-import me-1"></i> <?=$jatbi->lang('Import Excel')?>
                            </button>
                            <button class=" ms-3 mt-1 click-update btn btn-sm btn-outline-danger" data-action="modal"
                                data-url="/api/ingredient-import/cancel" data-selector="[ingredient-list-result]"
                                data-load="this">
                                <i class="fa fa-times me-1"></i> Xóa phiếu
                            </button>
                        </div>
                        </div>
                        
                    <div class="table-responsive">
                        <table class="table table-hover align-middle small">
                            <thead class="table-light">
                                <tr>
                                    <th class="p-2">Nguyên liệu</th>
                                    <th width="12%" class="text-end p-2">Giá bán</th>
                                    <th width="12%" class="text-center p-2">Số lượng tồn</th>
                                    <th width="12%" class="text-center p-2">Số lượng</th>
                                    <th width="10%" class="p-2">Đơn vị</th>
                                    <th width="12%" class="text-end p-2">Thành tiền</th>
                                    <th width="15%" class="p-2">Ghi chú</th>
                                    <th width="5%" class="text-center p-2">Xóa</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php
                               
                                $cookie_name = 'ingredient_import';
                                
                                // 2. Đọc và giải mã cookie bằng $app->getCookie()
                               
                                $cookie_json = $app->getCookie($cookie_name);
                                $cookie_data = $cookie_json ? json_decode($cookie_json, true) : null;

                                if (!is_array($cookie_data) || !isset($cookie_data['ingredients'])) {
                                    $cookie_data = ['ingredients' => [], 'content' => ''];
                                }
                                
                                // 3. Lấy danh sách nguyên liệu từ dữ liệu cookie
                                $SelectIngredients = $cookie_data['ingredients'] ?? [];
                                

                                if (empty($SelectIngredients)):
                                ?>
                                <tr>
                                    <td colspan="8" class="text-center p-4 text-muted">Chưa có nguyên liệu nào.</td>
                                </tr>
                                <?php
                                else:
                                    $total_selling_price = 0;
                                    $total_stock_quantity = 0;
                                    $total_amount = 0;
                                    $total = 0;
                                    foreach ($SelectIngredients as $key => $item):
                                  
                                        $selling_price = floatval($item['selling_price'] ?? 0);
                                        $stock_quantity = floatval($item['stock_quantity'] ?? 0);
                                        $amount = floatval($item['amount'] ?? 0);
                                        $total_price = $amount * $selling_price;
                                        $total_selling_price += $selling_price; 
                                        $total_stock_quantity += $stock_quantity;
                                        $total_amount += $amount;
                                        $total += $total_price;
                                ?>
                                <tr>
                                    <td>
                                        <strong>
                                            <?= htmlspecialchars($item['code'])?? '' ?>
                                        </strong><br>
                                        <small>
                                            <?= htmlspecialchars($item['name'])?? '' ?>
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <?= number_format($selling_price) ?>
                                    </td>
                                    <td class="text-center">
                                        <?= number_format($stock_quantity) ?>
                                    </td>
                                    <td class="text-center">
                                        <input type="number"
                                            class="form-control form-control-sm text-center blur-update"
                                            data-action="blur" id="amount-<?= $key; ?>"
                                            data-form='{"value": "#amount-<?=$key;?>.val"}'
                                            data-url="/api/ingredient-import/update-amount/<?= $key ?>"
                                            value="<?= htmlspecialchars($amount) ?>" min="1" data-load="this">
                                    </td>
                                    <td>
                                        <?= htmlspecialchars($item['unit_name'] ?? '') ?>
                                    </td>
                                    <td class="text-end fw-bold">
                                        <?= number_format($total_price) ?>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm blur-update"
                                            data-url="/api/ingredient-import/update-notes/<?= $key ?>"
                                            data-action="blur" id="notes-<?= $key; ?>"
                                            data-form='{"value": "#notes-<?=$key;?>.val"}'
                                            value="<?= htmlspecialchars($item['notes'] ?? '') ?>"
                                            placeholder="Ghi chú..." >
                                    </td>
                                    <td class="text-center">
                                        <a class="click-update text-danger" data-load="this" data-action="modal"
                                            data-selector="[ingredient-list-result]"
                                            data-url="/api/ingredient-import/delete/<?= $key ?>">
                                            <i class="ti ti-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                <?php
                                    endforeach;
                                endif;
                                ?>
                            </tbody>
                            <?php if (!empty($SelectIngredients)): ?>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="1" class="text-end fw-bold">Tổng cộng</td>
                                    <td class="text-end fw-bold">
                                        <?= number_format($total_selling_price) ?>
                                    </td>
                                    <td class="text-center fw-bold">
                                        <?= number_format($total_stock_quantity) ?>
                                    </td>
                                    <td class="text-center fw-bold">
                                        <?= number_format($total_amount) ?>
                                    </td>
                                    <td></td>
                                    <td class="text-end fw-bold">
                                        <?= number_format($total) ?>
                                    </td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                            <?php endif; ?>
                        </table>
                    </div>
                    <?php if(!empty($SelectIngredients)): ?>
                    <?php
                        // --- ĐỌC NỘI DUNG TỪ COOKIE (Đã dùng $cookie_data ở trên) ---
                        $import_content = $cookie_data['content'] ?? '';
                        ?>
                    <div class="mb-3 mt-3">
                        <label class="col-form-label">Nội dung phiếu nhập <span class="text-danger">*</span></label>
                        <textarea  class="form-control form-control-sm" id="import_content"
                            data-url="/api/ingredient-import/set-content" data-action="blur"
                            data-form='{"value": "#import_content.val"}'
                            placeholder="Nhập nội dung phiếu nhập..."><?=htmlspecialchars($import_content)?></textarea>
                    </div>

                    <div class="mt-4">
                        <button class=" btn btn-eclo w-100 p-2 fs-5" data-action="modal" type="button"
                            data-url="/api/ingredient-import/completed">
                            <i class="fa fa-check me-2"></i> Hoàn tất 
                        </button>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
</div>