<?php
function docso($number) {
    if (!is_numeric($number)) {
        return $number;
    }

    $hyphen      = ' ';
    $conjunction = ' ';
    $separator   = ' ';
    $negative    = 'âm ';
    $decimal     = ' phẩy ';
    $dictionary  = array(
        0                   => 'không',
        1                   => 'một',
        2                   => 'hai',
        3                   => 'ba',
        4                   => 'bốn',
        5                   => 'năm',
        6                   => 'sáu',
        7                   => 'bảy',
        8                   => 'tám',
        9                   => 'chín',
        10                  => 'mười',
        11                  => 'mười một',
        12                  => 'mười hai',
        13                  => 'mười ba',
        14                  => 'mười bốn',
        15                  => 'mười lăm',
        16                  => 'mười sáu',
        17                  => 'mười bảy',
        18                  => 'mười tám',
        19                  => 'mười chín',
        20                  => 'hai mươi',
        30                  => 'ba mươi',
        40                  => 'bốn mươi',
        50                  => 'năm mươi',
        60                  => 'sáu mươi',
        70                  => 'bảy mươi',
        80                  => 'tám mươi',
        90                  => 'chín mươi',
        100                 => 'trăm',
        1000                => 'nghìn',
        1000000             => 'triệu',
        1000000000          => 'tỷ',
        1000000000000       => 'nghìn tỷ',
        1000000000000000    => 'triệu tỷ',
        1000000000000000000 => 'tỷ tỷ'
    );

    if ($number < 0) {
        return $negative . docso(abs($number));
    }

    $string = $fraction = null;

    if (strpos($number, '.') !== false) {
        list($number, $fraction) = explode('.', $number);
    }

    switch (true) {
        case $number < 21:
            $string = $dictionary[$number];
            break;
        case $number < 100:
            $tens   = ((int) ($number / 10)) * 10;
            $units  = $number % 10;
            $string = $dictionary[$tens];
            if ($units) {
                // Xử lý "lăm" cho số 5 và "mốt" cho số 1
                if ($units == 1 && $tens > 10) {
                    $string .= $hyphen . 'mốt';
                } else if ($units == 5 && $tens > 10) {
                     $string .= $hyphen . 'lăm';
                } else {
                     $string .= $hyphen . $dictionary[$units];
                }
            }
            break;
        case $number < 1000:
            $hundreds  = $number / 100;
            $remainder = $number % 100;
            $string = $dictionary[(int)$hundreds] . ' ' . $dictionary[100];
            if ($remainder) {
                 // Xử lý "linh"
                if ($remainder < 10) {
                    $string .= $conjunction . 'linh ' . $dictionary[$remainder];
                } else {
                    $string .= $conjunction . docso($remainder);
                }
            }
            break;
        default:
            $baseUnit = pow(1000, floor(log($number, 1000)));
            $numBaseUnits = (int) ($number / $baseUnit);
            $remainder = $number % $baseUnit;
            $string = docso($numBaseUnits) . ' ' . $dictionary[$baseUnit];
            if ($remainder) {
                $string .= $remainder < 100 ? $conjunction . 'không trăm ' : $separator;
                // Đảm bảo các số 0 ở giữa được đọc đúng
                if($remainder < 100 && $remainder >= 10){
                     $string .= 'linh ';
                }
                elseif($remainder < 10){
                     $string .= 'linh không ';
                }

                $string .= docso($remainder);
            }
            break;
    }

    if (null !== $fraction && is_numeric($fraction)) {
        $string .= $decimal;
        $words = array();
        foreach (str_split((string) $fraction) as $number) {
            $words[] = $dictionary[$number];
        }
        $string .= implode(' ', $words);
    }

    return $string;
}
?>
<div class="modal fade modal-load" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: white;">
            <div class="modal-header d-print-none">
                <h5 class="modal-title">
                    <?php echo htmlspecialchars($title); ?>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; color:#000;">
                    <div style="text-transform: uppercase; width: 60%;">
                        <h6 class="p-0 m-0">CÔNG TY TNHH MỘT THÀNH VIÊN NGỌC TRAI NGỌC HIỀN PHÚ QUỐC</h6>
                    </div>
                    <div class="text-center" style="width: 40%;">
                        <strong>Mẫu số 01 - VT</strong>
                        <h6 class="small"><i>(Ban hành theo Thông tư số 133/2016/TT-BTC Ngày 26/08/2016 của Bộ Tài
                                Chính)</i></h6>
                    </div>
                </div>
                <div class="text-center my-3" style="color:#000;">
                    <?php if ($data['type'] == 'import') { ?>
                    <h4 style="color:#000;">PHIẾU NHẬP KHO</h4>
                    <?php } elseif ($data['type'] == 'export' || $data['type'] == 'move_products') { ?>
                    <h4 style="color:#000;">PHIẾU XUẤT KHO</h4>
                    <?php } elseif ($data['type'] == 'cancel') { ?>
                    <h4 style="color:#000;">PHIẾU HỦY KHO</h4>
                    <?php } else { ?>
                    <h4 style="color:#000;">PHIẾU KHO</h4>
                    <?php } ?>
                    <h6><i>
                            <?php echo htmlspecialchars($jatbi->lang('Ngày') ?? 'Ngày'); ?>:
                            <?php echo htmlspecialchars(isset($jatbi->datetime) ? $jatbi->datetime($data['date']) : date($setting['site_date'] ?? 'd/m/Y', strtotime($data['date']))); ?>
                        </i></h6>
                </div>
                <div class="row mt-3">
                    <div class="col-lg-6 mb-2"><strong>
                            <?php echo htmlspecialchars($jatbi->lang('Mã xuất kho') ?? 'Mã xuất kho'); ?>:
                        </strong> #
                        <?php echo htmlspecialchars($data['code'] . $data['id']); ?>
                    </div>
                    <div class="col-lg-6 mb-2"><strong>
                            <?php echo htmlspecialchars($jatbi->lang('Ngày tạo') ?? 'Ngày tạo'); ?>:
                        </strong>
                        <?php echo htmlspecialchars(isset($jatbi->datetime) ? $jatbi->datetime($data['date_poster']) : date($setting['site_datetime'] ?? 'd/m/Y H:i:s', strtotime($data['date_poster']))); ?>
                    </div>
                    <!-- <div class="col-lg-6 mb-2"><strong><?php echo htmlspecialchars($jatbi->lang('Cửa hàng') ?? 'Cửa hàng'); ?>:</strong> <?php echo htmlspecialchars($data['store_name'] ?? 'N/A'); ?></div> -->
                    <!-- <div class="col-lg-6 mb-2"><strong><?php echo htmlspecialchars($jatbi->lang('Quầy hàng') ?? 'Quầy hàng'); ?>:</strong> <?php echo htmlspecialchars($data['branch_name'] ?? 'N/A'); ?></div> -->
                    <div class="col-lg-6 mb-2"><strong>
                            <?php echo htmlspecialchars($jatbi->lang('Tài khoản') ?? 'Tài khoản'); ?>:
                        </strong>
                        <?php echo htmlspecialchars($data['user_name']); ?>
                    </div>
                    <div class="col-lg-6 mb-2"><strong>
                            <?php echo htmlspecialchars($jatbi->lang('Nội dung') ?? 'Nội dung'); ?>:
                        </strong>
                        <?php echo htmlspecialchars($data['content']); ?>
                    </div>
                </div>
                <!-- Bảng chi tiết sản phẩm -->
                <div class="table-responsive mt-3">
                    <table class="table table-sm table-hover table-striped table-bordered align-middle">
                        <thead class="table-light text-center">
                            <tr>
                                <th class="p-2"><?=$jatbi->lang('NGUYÊN LIỆU')?></th>
                                <th class="p-2"><?=$jatbi->lang('NHÀ CUNG CẤP')?></th>
                                <th class="p-2" width="12%"><?=$jatbi->lang('ĐƠN GIÁ')?></th>
                                <th class="p-2" width="10%"><?=$jatbi->lang('SỐ LƯỢNG')?></th>
                                <th class="p-2"><?=$jatbi->lang('ĐƠN VỊ')?></th>
                                <th class="p-2" width="15%"><?=$jatbi->lang('THÀNH TIỀN')?></th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($details as $item): ?>
                            <tr>
                                <td class="p-2">
                                    <?php echo htmlspecialchars($item['ingredient_code'] ?? ''); ?>
                                </td>
                                <td class="p-2">
                                    <?php echo htmlspecialchars($item['vendor_name'] ?? ''); ?>
                                </td>
                                <td class="p-2 text-end">
                                    <?php echo number_format($item['price'] ?? 0); ?>
                                </td>
                                <td class="p-2 text-center">
                                    <?php echo htmlspecialchars($item['amount'] ?? 0); ?>
                                </td>
                                <td class="p-2 text-center">
                                    <?php echo htmlspecialchars($item['unit_name'] ?? ''); ?>
                                </td>
                                <td class="p-2 text-end fw-bold">
                                    <?php echo number_format(($item['price'] ?? 0) * $item['amount']); ?>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>

                        <tfoot class="table-light fw-bold">
                            <tr>
                                <td colspan="2" class="p-2 text-end"><?=$jatbi->lang('Tổng cộng')?></td>
                                <td class="p-2 text-end">
                                    <?=number_format($total_price)?>
                                </td>
                                <td class="p-2 text-center">
                                    <?=number_format($total_amount)?>
                                </td>
                                <td></td>
                                <td class="p-2 text-end">
                                    <?=number_format($grand_total)?>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="mt-3">
                        <p><strong><?=$jatbi->lang('Tổng số tiền (viết bằng chữ)')?>:</strong>
                            <?php 

                                echo ucfirst(docso($grand_total)) . ' đồng.'; 
                            ?>
                        </p>
                        <p><strong><?=$jatbi->lang('Số chứng từ gốc kèm theo')?>:</strong>
                            ............................................................</p>
                    </div>
                    <div style="display: flex;justify-content: space-between;color:#000">
	                <div class="font-weight-bold" style="display: inline-block;text-transform: uppercase;; width: 60%"></div>
	                <div class="text-center" style="display: inline-block;; width: 40%">
	                    <p><span class="font-weight-bold font-italic"><i>Ngày .... Tháng .... Năm .....</i></span></p>
	                </div>
	            </div>
                </div>
                <div class="mt-4">
                    <table style="width: 100%;">
                        <tr>
                            <td style="width: 33%; text-align: center;"><strong>Người Lập</strong></td>
                            <td style="width: 33%; text-align: center;"><strong>Thủ Kho</strong></td>
                            <td style="width: 33%; text-align: center;"><strong>Người Nhận</strong></td>
                        </tr>
                        <tr>
                            <td style="text-align: center;"><i>(Ký, họ tên)</i></td>
                            <td style="text-align: center;"><i>(Ký, họ tên)</i></td>
                            <td style="text-align: center;"><i>(Ký, họ tên)</i></td>
                        </tr>
                        <tr>
                            <td style="padding-top: 80px; text-align: center;">
                                <?php echo htmlspecialchars($data['user_name']); ?>
                            </td>
                            <td style="padding-top: 80px; text-align: center;"></td>
                            <td style="padding-top: 80px; text-align: center;"></td>
                        </tr>
                    </table>
                </div>
            </div>
            <!-- <div class="modal-footer d-print-none">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <?php echo htmlspecialchars($jatbi->lang('Hủy') ?? 'Hủy'); ?>
                </button>
                <button class="btn btn-success" onclick="window.print();">
                    <?php echo htmlspecialchars($jatbi->lang('In') ?? 'In'); ?>
                </button>
            </div> -->
                   <div class="modal-footer d-print-none border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal"><?=$jatbi->lang('Hủy')?></button>
                <button class="btn btn-success rounded-pill px-4 btn-print" ><i class="ti ti-printer me-2"></i><?=$jatbi->lang('IN')?></button>
            </div>
        </div>
    </div>
</div>