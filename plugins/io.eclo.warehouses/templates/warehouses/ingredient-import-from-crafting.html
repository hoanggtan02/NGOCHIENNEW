<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="text-center mb-4">
                <i class="ti ti-packages text-eclo" style="font-size: 70px;"></i>
                <h3 class="fw-bold mt-2">
                    <?=$title?>
                </h3>
            </div>

            <div class="card bg-body bg-opacity-50 shadow border-0 rounded-4 mt-4" ingredient-list-result>
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center px-2 mb-3">
                        <h6 class="fw-bold mb-0">Danh sách nguyên liệu trong phiếu</h6>
                        <button class="click-update btn btn-sm btn-outline-danger" data-action="modal"
                            data-url="/api/ingredient-crafting/cancel" data-selector="[ingredient-list-result]"
                            data-load="this">
                            <i class="fa fa-times me-1"></i> Hủy phiếu
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle small">
                            <thead class="table-light">
                                <tr>
                                    <th class="p-2">Nguyên liệu</th>
                                    <th width="12%" class="text-end p-2">Giá bán</th>
                                    <th width="12%" class="text-center p-2">Số lượng tồn</th>
                                    <th width="12%" class="text-center p-2">Số lượng</th>
                                    <th width="10%" class="p-2">Đơn vị</th>
                                    <th width="12%" class="text-end p-2">Thành tiền</th>
                                    <th width="20%" class="p-2">Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php
                                $SelectIngredients = $_SESSION['ingredient_import_crafting']['ingredients'] ?? [];
                                if (empty($SelectIngredients)):
                                ?>
                                <tr>
                                    <td colspan="7" class="text-center p-4 text-muted">Không có nguyên liệu trong phiếu.
                                    </td>
                                </tr>
                                <?php else:
                                    
                                    $total_selling_price = 0;
                                    $total_stock_quantity = 0;
                                    $total_amount = 0;
                                    $total = 0;
                                    foreach ($SelectIngredients as $key => $item):
                                        $selling_price = $item['selling_price'] ?? 0;
                                        $stock_quantity = $item['stock_quantity'] ?? 0;
                                        $amount = $item['amount'] ?? 0;
                                        $total_price = $amount * $selling_price;
                                        // THÊM: Tính toán tổng
                                        $total_selling_price += $selling_price;
                                        $total_stock_quantity += $stock_quantity;
                                        $total_amount += $amount;
                                        $total += $total_price;
                                ?>
                                <tr>
                                    <td>
                                        <strong>
                                            <?= htmlspecialchars($item['code']??'') ?>
                                        </strong><br>
                                        <small>
                                            <?= htmlspecialchars($item['name']??'') ?>
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <?= number_format($selling_price)?? 0 ?>
                                    </td>
                                    <td class="text-center">
                                        <?= number_format($stock_quantity)?? 0 ?>
                                    </td>
                                    <td class="text-center">
                                        <input type="number" class="form-control form-control-sm text-center"
                                            value="<?= htmlspecialchars($amount) ?>" readonly>
                                    </td>
                                    <td>
                                        <?= htmlspecialchars($item['unit_name'] ?? '') ?>
                                    </td>
                                    <td class="text-end fw-bold">
                                        <?= number_format($total_price)?? 0 ?>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm blur-update"
                                            data-url="/api/ingredient-crafting/update-notes/<?= $key ?>"
                                            data-action="blur" id="notes-<?= $key; ?>"
                                            data-form='{"value": "#notes-<?=$key;?>.val"}'
                                            value="<?= htmlspecialchars($item['notes'] ?? '') ?>"
                                            placeholder="Ghi chú...">
                                    </td>
                                </tr>
                                <?php endforeach; endif; ?>
                            </tbody>

                            <?php if (!empty($SelectIngredients)): ?>
                            <tfoot class="table-light">
                                <tr>
                                    <td class="text-end fw-bold">Tổng cộng</td>
                                    <td class="text-end fw-bold">
                                        <?= number_format($total_selling_price) ?>
                                    </td>
                                    <td class="text-center fw-bold">
                                        <?= number_format($total_stock_quantity) ?>
                                    </td>
                                    <td class="text-center fw-bold">
                                        <?= number_format($total_amount) ?>
                                    </td>
                                    <td></td>
                                    <td class="text-end fw-bold">
                                        <?= number_format($total) ?>
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                            <?php endif; ?>
                        </table>
                    </div>
                    <?php if(!empty($SelectIngredients)): ?>
                    <!-- <div class="mb-3 mt-3 px-2">
                            <label class="col-form-label">Nội dung phiếu nhập <span class="text-danger">*</span></label>
                            <textarea class="form-control form-control-sm" id="import_content"
                                data-url="/api/ingredient-crafting/set-content" data-action="blur"
                                data-form='{"value": "#import_content.val"}' 
                                value="<?=htmlspecialchars($_SESSION['ingredient_import_crafting']['content'] ?? '')?>"
                                placeholder="Nhập nội dung phiếu nhập..."></textarea>
                        </div> -->
                    <div class="mb-3 mt-3 px-2">
                        <label class="col-form-label">Nội dung phiếu nhập <span class="text-danger">*</span></label>
                        <textarea class="form-control form-control-sm" id="import_content"
                            data-url="/api/ingredient-crafting/set-content" data-action="blur"
                            data-form='{"value": "#import_content.val"}'
                            placeholder="Nhập nội dung phiếu nhập..."><?=htmlspecialchars($_SESSION['ingredient_import_crafting']['content'] ?? '')?></textarea>
                    </div>
                    <div class="mt-4 px-2">
                        <button class="btn btn-eclo w-100 p-2 fs-5" data-action="modal" type="button"
                            data-url="/api/ingredient-crafting/completed">
                            <i class="fa fa-check me-2"></i> Hoàn tất
                        </button>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
</div>