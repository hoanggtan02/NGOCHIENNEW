<div class="container" data-pos-this>
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0 fw-bold text-body">
                <?=$title?>
            </h4>
            <ul class="breadcrumb small mb-0">
                <li class="breadcrumb-item small">
                    <a href="<?=$jatbi->url('/')?>" data-pjax class="link-secondary"><?=$jatbi->lang("Trang chủ")?></a>
                </li>
                <li class="breadcrumb-item small text-body" aria-current="page">
                    <?=$title?>
                </li>
            </ul>
        </div>
    </div>
    <div class="row g-2 px-5">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <?=$app->component('select', [
                            'name' => 'stores',
                            'placeholder' => $jatbi->lang("Cửa hàng"),
                            'required' => true,
                            'options' => $storess,
                            'selected' => $_SESSION['inventory_table'][$action]['stores']['id'] ?? '',
                            'class' => 'change-update',
                            "attr" => 'data-action="change" data-load = "this"
                                data-url="/accountants/inventory_table-update/'.$action.'/stores" 
                                data-form=\'{"value": "this.val"}\''
                        ])?>
                        <?=$app->component('input',[
                            "type" => "date",
                            "name"=>'date',
                            'required' => true,
                            "placeholder"=>$jatbi->lang("Ngày"),
                            "value" => $data['date'] ??  date('d/m/Y'),
                            "class" => 'filter-name',
                            "attr" => 'data-width="100%" data-load = "this"
                                        data-action = "blur" data-form=\'{"value": "this.val"}\'
                                        data-url="/accountants/inventory_table-update/'.$action.'/date"',
                        ])?>
                    </div>
                    <div class="mb-3">
                        <div class="bg-body rounded-pill p-2 d-flex justify-content-center align-items-center" data-pos-table>
                            <i class="ti ti-search fs-3 ms-2"></i>
                            <div class="w-100" data-search="true" data-url="/accountants/products-inventory_table">
                                <input type="text"
                                    class="form-control bg-transparent border-0 shadow-none py-3 w-100"
                                    placeholder="Tìm kiếm">
                                <div class="search-results-box rounded-4 shadow bg-body border-0 position-absolute max-height scroll-y w-100 z-3"
                                    style="--max-height:300px;"></div>
                                <template class="search-item-template">
                                    <div class="search-item border-0 py-2 btn text-start position-relative"
                                        style="display: flex; align-items: center; gap: 10px;">
                                        <div data-attr-products="value">
                                            <strong data-name="text"></strong><br>
                                            <a data-action="click" data-load="this"
                                                data-selector="[data-pos-table]"
                                                data-attr-url="url" class="stretched-link" href="#!"></a>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-striped table-bordered align-middle">
                            <thead>
                                <tr>
                                    <th>Mã sản phẩm</th>
                                    <th>Sản phẩm</th>
                                    <th>Giá tiền</th>
                                    <th>Số lượng theo sổ kế toán</th>
                                    <th>Số lượng kiểm kê</th>
                                    <th>Thành tiền</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody data-pos-table>
                                <?php 
                                $nhap = $xuat = $chuyen = $huy = [];

                                foreach ($SelectProducts as $key => $SelectProduct) {
                                    $getPro = $app->get("products","*",["id"=>$SelectProduct['products']]);
                                    $thanhtien = $getPro['price'] * $SelectProduct['amount'];
                                    
                                    $soluong = $app->select("warehouses_logs", ["products","amount","type","data"], [
                                        "products" => $SelectProduct['products'],
                                        "date[<=]" => $_SESSION['inventory_table'][$action]['date']
                                    ]);

                                    foreach ($soluong as $sl) {
                                        $productId = $SelectProduct['products'];
                                        
                                        if (!isset($nhap[$productId])) $nhap[$productId] = 0;
                                        if (!isset($xuat[$productId])) $xuat[$productId] = 0;
                                        if (!isset($chuyen[$productId])) $chuyen[$productId] = 0;
                                        if (!isset($huy[$productId])) $huy[$productId] = 0;

                                        if ($sl['type'] == 'import' && $sl['data'] == "products") {
                                            $nhap[$productId] += $sl['amount'];
                                        } elseif ($sl['type'] == 'export' && $sl['data'] == "products") {
                                            $xuat[$productId] += $sl['amount'];
                                        } elseif ($sl['type'] == 'move' && $sl['data'] == "products") {
                                            $chuyen[$productId] += $sl['amount'];
                                        } elseif ($sl['type'] == 'error' && $sl['data'] == "products") {
                                            $huy[$productId] += $sl['amount'];
                                        }
                                    }

                                    $slkt[$productId] = $nhap[$productId] - $xuat[$productId] - $chuyen[$productId] - $huy[$productId];
                                ?>
                                <tr>
                                    <td class="p-2"><?=$getPro['code']?></td>
                                    <td class="p-2"><?=$getPro['name']?></td>
                                    <td class="p-2"><?=number_format($getPro['price'])?></td>
                                    <td class="p-2"><?=number_format($slkt[$SelectProduct['products']],1)?></td>
                                    <td class="p-2">
                                        <input type="text" name="amount" data-action="blur" data-selector="[data-pos-table]"
                                                class="blur-update border-0 w-100  h-100 p-2 bg-transparent" data-form='{"value": "this.val"}'
                                                data-url="/accountants/inventory_table-update/<?=$action?>/products/amount/<?=$key?>" 
                                                value="<?=$SelectProduct['amount']?>" data-load="this">
                                    </td>
                                    <td class="p-2"><?=number_format($thanhtien)?></td>
                                    <td class="text-center">
                                        <a class="click-update text-danger" data-load="this" data-action="click"
                                            data-alert="true" data-selector="[data-pos-table]"
                                            data-url="/accountants/inventory_table-update/<?=$action?>/products/deleted/<?=$key?>">
                                            <i class="ti ti-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                <?php } ?>
                            </tbody>
                        </table>
                    </div>
                    <div class="mb-3">
                        <?=$app->component('textarea', [
                            "name" => "content",
                            "placeholder" => $jatbi->lang("Xử lý"),
                            "value" => $data['content'] ?? '',
                            "attr" => 'style="height: 100px;"
                                        data-action = "blur" data-load = "this" data-form=\'{"value": "this.val"}\'
                                        data-url="/accountants/inventory_table-update/'.$action.'/content"',
                            "required" => true,
                        ])?>
                    </div>
                </div>
                    <div class="card-footer text-end bg-light border-0">
                        <a 
                            class="btn btn-eclo-light py-3 rounded-4 me-2" 
                            data-load="this" data-action="modal"
                            data-url="/accountants/inventory_table-update/<?=$action?>/cancel"
                        >Hủy</a>
                        <a 
                            class="btn btn-danger py-3 rounded-4 me-2" 
                            data-load="this" data-action="modal" data-alert="true"
                            data-url="/accountants/inventory_table-update/<?=$action?>/completed"
                        >Hoàn tất</a>
                    </div>
            </div>
        </div>
    </div>
</div>