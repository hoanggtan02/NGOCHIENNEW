<div class="container pb-5 mb-5">
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0 fw-bold text-body"><?=$title?></h4>
            <ul class="breadcrumb small mb-0">
                <li class="breadcrumb-item small">
                    <a href="/" class="pjax-load link-secondary"><?=$jatbi->lang("Trang chủ")?></a>
                </li>
                <li class="breadcrumb-item small text-body" aria-current="page"><?=$title?></li>
            </ul>
        </div>
        <div class="text-body">
            <div>
                <strong><?=$jatbi->lang("Người đề xuất")?>:</strong>
                <?=$data['account']?>   
            </div>   
            <div class="small">
                <strong><?=$jatbi->lang("Ngày tạo")?>:</strong>
                <small><?=$jatbi->datetime($data['create'])?></small>
            </div>       
        </div>
    </div>
    <div class="row g-3">
        <div class="col-lg-9">
            <div class="card bg-body shadow-lg border-0 bg-opacity-50 rounded-4 mb-4">
                <div class="card-body">
                    <div class="row g-2 align-items-start">
                      <!-- Cột trái -->
                      <div class="col-lg-3 col-6 fw-bold text-uppercase text-truncate">
                        <?=$jatbi->lang("Đề xuất")?>: #<?=$data['id']?>
                      </div>

                      <!-- Cột phải -->
                      <div class="col-lg-9 col-6">
                        <nav class="navbar navbar-expand-lg justify-content-lg-end p-0">
                          <!-- Nút menu khi mobile -->
                          <button class="navbar-toggler ms-auto border-0" type="button" data-bs-toggle="collapse" data-bs-target="#proposalActions" aria-controls="proposalActions" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="ti ti-menu-2 fs-3"></span>
                          </button>

                          <!-- Danh sách nút -->
                          <div class="collapse navbar-collapse justify-content-lg-end mt-2 mt-lg-0" id="proposalActions">
                            <div class="d-flex flex-wrap justify-content-end gap-2">
                              <?php if(($data['account_id']==$account['id']) &&  ($data['status_id']==1 ||  $data['status_id']==2 ||  $data['status_id']==3) ){ ?>
                                <button class="btn btn-sm btn-danger py-1 rounded-pill fw-bold text-light" data-action="modal" data-url="/proposal/cancel/<?=$data['active']?>">
                                  <i class="ti ti-cancel me-1"></i> <?=$jatbi->lang("Hủy")?>
                                </button>
                              <?php } ?>

                              <?php if($data['status_id']==2 ||  $data['status_id']==4){ ?>
                                <button class="btn btn-sm btn-info py-1 rounded-pill fw-bold">
                                  <i class="ti ti-printer me-1"></i> <?=$jatbi->lang("In đề xuất")?>
                                </button>
                                <?php if($jatbi->permission(['proposal.reality']) == 'true' && $checkReality<$data['price']){ ?>
                                  <button class="btn btn-sm btn-primary text-light py-1 rounded-pill fw-bold"
                                    data-action="modal" data-url="/proposal/reality/<?=$data['active']?>">
                                    <i class="ti ti-library me-1"></i> <?=$jatbi->lang("Bút toán")?> (<?=count($realitys ?? 0)?>)
                                  </button>
                                <?php } ?>
                              <?php } ?>

                              <?php if($data['status_id']==1 || $data['status_id']==10){ ?>
                              <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-eclo py-1 rounded-start-pill fw-bold"
                                  data-action="click" data-confirm="Bạn có muốn buzz đề xuất này"
                                  data-url="/proposal/buzz/<?=$data['active']?>" data-alert="true">
                                  <i class="fa-solid fa-bolt me-2"></i> Buzz
                                </button>
                                <button type="button" class="btn btn-sm btn-eclo py-1 dropdown-toggle rounded-end-pill"
                                  data-bs-toggle="dropdown" aria-expanded="false"></button>
                                <ul class="dropdown-menu dropdown-menu-end border-0 rounded-4 shadow-lg">
                                  <li>
                                    <a class="dropdown-item rounded-pill btn" data-action="modal"
                                       data-url="/proposal/buzz-views/<?=$data['active']?>">
                                       <?=$jatbi->lang("Lịch sử Buzz")?>
                                    </a>
                                  </li>
                                </ul>
                              </div>
                              <?php } ?>

                              <?php if($data['status_id']==1 || $data['status_id']==2 || $data['status_id']==4 || $data['status_id']==5 || $data['status_id']==10){ ?>
                              <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-warning text-light py-1 rounded-start-pill fw-bold"
                                  data-action="modal" data-url="/proposal/remind/<?=$data['active']?>">
                                  <i class="fa-solid fa-bolt me-2"></i> Nhắc nhở
                                </button>
                                <button type="button" class="btn btn-sm btn-warning text-light py-1 dropdown-toggle rounded-end-pill"
                                  data-bs-toggle="dropdown" aria-expanded="false"></button>
                                <ul class="dropdown-menu dropdown-menu-end border-0 rounded-4 shadow-lg">
                                  <li>
                                    <a class="dropdown-item rounded-pill btn" data-action="modal"
                                       data-url="/proposal/remind-views/<?=$data['active']?>">
                                       <?=$jatbi->lang("Lịch sử")?>
                                    </a>
                                  </li>
                                </ul>
                              </div>
                              <?php } ?>

                            </div>
                          </div>
                        </nav>
                      </div>
                    </div>

                    <div class="border my-4"></div>
                    <?php if($data['status_id']==10 || $data['status_id']==20){ ?>
                        <div class="bg-eclo text-light rounded-4 p-3 mb-3">
                            <strong><?=$app->get("accounts","name",["id"=>$cancels[0]['account']])?></strong> Yêu cầu hủy đề xuất với lý do: <strong><?=$cancels[0]['approval_content']?></strong> lúc <?=$jatbi->datetime($cancels[0]['date'])?>
                        </div>
                    <?php } ?>


                    <?php if($data['status_id']==4 || $data['status_id']==5){
                        $color_reality = 'primary';
                        foreach($realitys as $reality){
                        if($reality['reality']<$data['price']){
                            $color_reality = 'info';
                        }
                        elseif($reality['reality']>$data['price']){
                            $color_reality = 'danger';
                        }
                    ?>
                        <div class="bg-success-subtle rounded-4 p-3 mb-3 d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0"><strong><?=$app->get("accounts","name",["id"=>$reality['reality_account']])?> Đã bút toán</strong></p>
                                <p class="mb-0">Số tiền: <strong class="text-<?=$color_reality?>"><?=$jatbi->money($reality['reality'])?></strong></p>
                                <p class="mb-0">Ngày: <strong><?=$jatbi->date($reality['reality_date'])?> </strong></p>
                                <p class="mb-0">Nội dung: <strong><?=$reality['reality_content']?></strong></p>
                                <p class="mb-0">Hình thức: <strong><?=$reality['form']?></strong></p>
                                <p class="mb-0">Hạng mục: <strong><?=$reality['category']?></strong></p>

                            </div>
                            <?php if($reality['reality_account']==$account['id']){ ?>
                                <button class="btn btn-sm p-0 border-0" data-action="modal" data-url="/proposal/reality-deleted?box=<?=$reality['active']?>"><i class="ti ti-trash fs-4 text-eclo"></i></button>
                            <?php } ?>
                        </div>
                        <?php } ?>
                    <?php } ?>
                    <div class="row g-4">
                        <div class="col-lg-12">
                            <label class="fst-italic d-block text-muted"><?=$jatbi->lang("Nội dung")?>: </label>
                            <strong><?=$data['content']?></strong>
                        </div>
                        <div class="col-lg-3 col-6">
                            <label class="fst-italic d-block text-muted"><?=$jatbi->lang("Đề xuất")?>: </label>
                            <strong class="<?=$color?>"><?=$data['type_name']?>: <?=$data['form']?></strong>
                        </div>
                        <div class="col-lg-3 col-6">
                            <label class="fst-italic d-block text-muted"><?=$jatbi->lang("Quy trình")?>: </label>
                            <strong><?=$data['workflows']?></strong>
                        </div>
                        <div class="col-lg-3 col-6">
                            <label class="fst-italic d-block text-muted"><?=$jatbi->lang("Hạng mục")?>: </label>
                            <strong><?=$data['category']?></strong>
                        </div>
                        <div class="col-lg-3 col-6">
                            <label class="fst-italic d-block text-muted"><?=$jatbi->lang("Mục tiêu")?>: </label>
                            <strong><?=$data['target']?></strong>
                        </div>
                        <div class="col-lg-3 col-6">
                            <label class="fst-italic d-block text-muted"><?=$jatbi->lang("Ngày dự kiến")?>: </label>
                            <strong><?=$jatbi->date($data['date'])?></strong>
                        </div>
                        <div class="col-lg-3 col-6">
                            <label class="fst-italic d-block text-muted"><?=$jatbi->lang("Số tiền")?>: </label>
                            <strong class="<?=$color?>"><?=$jatbi->money($data['total_price'])?></strong>
                        </div>
                        <div class="col-lg-3 col-6">
                            <label class="fst-italic d-block text-muted mb-1"><?=$jatbi->lang("Tiến trình")?>: </label>
                            <strong><?=$data['process'] ?? ''?></strong>
                        </div>
                        <div class="col-lg-3 col-6">
                            <label class="fst-italic d-block text-muted mb-1"><?=$jatbi->lang("Trạng thái")?>: </label>
                            <strong><?=$data['status']?></strong>
                        </div>
                        <div class="col-lg-12">
                            <label class="fst-italic d-block text-muted mb-1"><?=$jatbi->lang("Ghi chút")?>: </label>
                            <strong><?=$data['notes']?></strong>
                        </div>
                    </div>
                    <div class="border my-4"></div>
                    <div class="">
                        <strong class="fst-italic text-muted"><?=$jatbi->lang("Đối tượng")?></strong>
                        <ul>
                            <?php if($data['objects']>0){ ?>
                            <li class="py-2"><?=$jatbi->lang("Đối tượng")?>: <?=$data['objects']?></li>
                            <?php } ?>
                            <?php if($data['customers']>0){ ?>
                            <li class="py-2"><?=$jatbi->lang("Khách hàng")?>: <?=$app->get("customers","name",["id"=>$data['customers']])?></li>
                            <?php } ?>
                            <?php if($data['vendors']>0){ ?>
                            <li class="py-2"><?=$jatbi->lang("Nhà cung cấp")?>: <?=$app->get("customers","name",["id"=>$data['vendors']])?></li>
                            <?php } ?>
                            <?php if($data['accounts']>0){ ?>
                            <li class="py-2"><?=$jatbi->lang("Tài khoản")?>: <?=$app->get("accounts","name",["id"=>$data['accounts']])?></li>
                            <?php } ?>
                            <?php if($data['proposals']>0){ ?>
                            <li class="py-2"><?=$jatbi->lang("Đề xuất kèm theo")?>: <?=$app->get("proposals","id",["id"=>$data['proposals']])?></li>
                            <?php } ?>
                            <?php if($data['accountants']>0){ ?>
                            <li class="py-2"><?=$jatbi->lang("Chứng từ")?>: <?=$app->get("accountants","id",["id"=>$data['accountants']])?></li>
                            <?php } ?>
                            <?php if($data['stores']>0){ ?>
                            <li class="py-2"><?=$jatbi->lang("Cửa hàng")?>: <?=$app->get("stores","name",["id"=>$data['stores']])?></li>
                            <?php } ?>
                        </ul>
                    </div>
                    <div class="border my-4"></div>
                    <div class="">
                        <strong><?=$jatbi->lang("Chứng từ kèm theo")?></strong>
                        <div class="row g-4 mt-2">
                            <?php if($data['invoices']>0){
                                $getInvoices = $app->get("invoices",["id","active","date"],["id"=>$data['invoices']]) ?? [];
                            ?>
                                <div class="col-lg-4">
                                    <div class="btn card p-2 rounded-4 shadow border-0" data-action="modal" data-url="/invoices/views/<?=$getInvoices['active']?>">
                                        <div class=" d-flex justify-content-start align-items-center text-start">
                                            <span class="file-icon me-2 rounded-3 lazyload" data-bgset="/assets/icons/folder.png" style="--width:50px;--height:50px;"></span>
                                            <div>
                                                <strong class="w-100 d-block">Số HĐ: #<?=$getInvoices['id']?></strong>
                                                <strong class="w-100 d-block">Ngày: <?=$jatbi->date($getInvoices['date'])?></strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <?php } ?>
                            <?php if($data['purchase']>0){
                                $getPurchase = $app->get("warehouses_invoices",["id","active","date"],["id"=>$data['purchase']]) ?? [];
                            ?>
                                <div class="col-lg-4">
                                    <div class="btn card p-2 rounded-4 shadow border-0" data-action="modal" data-url="/warehouses/purchase/views/<?=$getPurchase['active']?>">
                                        <div class=" d-flex justify-content-start align-items-center text-start">
                                            <span class="file-icon me-2 rounded-3 lazyload" data-bgset="/assets/icons/folder.png" style="--width:50px;--height:50px;"></span>
                                            <div>
                                                <strong class="w-100 d-block">Số phiếu: #<?=$getPurchase['id']?></strong>
                                                <strong class="w-100 d-block">Ngày: <?=$jatbi->date($getPurchase['date'])?></strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <?php } ?>
                            <?php if($data['quick_purchase']>0){
                                $getPurchase = $app->get("warehouses_quick_purchase",["id","active","date"],["id"=>$data['quick_purchase']]) ?? [];
                            ?>
                                <div class="col-lg-4">
                                    <div class="btn card p-2 rounded-4 shadow border-0" data-action="modal" data-url="/warehouses/quick-purchase/views/<?=$getPurchase['active']?>">
                                        <div class=" d-flex justify-content-start align-items-center text-start">
                                            <span class="file-icon me-2 rounded-3 lazyload" data-bgset="/assets/icons/folder.png" style="--width:50px;--height:50px;"></span>
                                            <div>
                                                <strong class="w-100 d-block">Số phiếu: #<?=$getPurchase['id']?></strong>
                                                <strong class="w-100 d-block">Ngày: <?=$jatbi->date($getPurchase['date'])?></strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <?php } ?>
                            <?php if($data['shifts']>0){
                                $getShifts = $app->get("shifts",["id","active","date"],["id"=>$data['shifts']]) ?? [];
                            ?>
                                <div class="col-lg-4">
                                    <div class="btn card p-2 rounded-4 shadow border-0" data-action="modal" data-url="/shifts/views/<?=$getShifts['active']?>">
                                        <div class=" d-flex justify-content-start align-items-center text-start">
                                            <span class="file-icon me-2 rounded-3 lazyload" data-bgset="/assets/icons/folder.png" style="--width:50px;--height:50px;"></span>
                                            <div>
                                                <strong class="w-100 d-block">Mã kết: #<?=$getShifts['id']?></strong>
                                                <strong class="w-100 d-block">Ngày: <?=$jatbi->date($getShifts['date'])?></strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <?php } ?>
                            <?php foreach($files as $file){ ?>
                                <div class="col-lg-4">
                                    <?php if($file['deleted']==0){ ?>
                                    <div class="btn card p-2 rounded-4 shadow border-0" data-action="modal" data-url="/files/files-views/<?=$file['active']?>">
                                        <div class=" d-flex justify-content-start align-items-center text-start">
                                            <span class="file-icon me-2 rounded-3 lazyload" data-bgset="<?=$jatbi->getFileIcon($file['active'])?>" style="--width:50px;--height:50px;"></span>
                                            <strong class="w-75"><?=$file['name']?></strong>
                                        </div>
                                    </div>
                                    <?php } else { ?>
                                    <div class="btn card p-2 rounded-4 shadow border-0 opacity-50" data-action="modal" data-url="/files/files-views/<?=$file['active']?>">
                                        <div class=" d-flex justify-content-start align-items-center text-start">
                                            <span class="file-icon me-2 rounded-3 lazyload" data-bgset="<?=$jatbi->getFileIcon($file['active'])?>" style="--width:50px;--height:50px;"></span>
                                            <strong class="w-75">Đã xóa</strong>
                                        </div>
                                    </div>
                                    <?php } ?>
                                </div>
                            <?php } ?>
                        </div>
                    </div>
                    <div class="border my-4"></div>
                    <div class="">
                        <strong class="mb-3 d-block"><?=$jatbi->lang("Chi tiết thêm")?></strong>
                        <table id="datatable-details" 
                            data-table 
                            class="table align-middle" 
                            data-type="POST" 
                            data-server="true" 
                            data-processing="true" 
                            data-page-length="10"
                            data-searching="true"
                            data-paging="true"
                            data-state-save='true'
                            style="width:100%">
                            <thead>
                                <tr>
                                    <th data-name="type" data-orderable="true" class="text-nowrap text-start" data-visible="true" data-class=""><?=$jatbi->lang("Loại")?></th>
                                    <th data-name="content" data-orderable="true" class="text-nowrap text-start" data-visible="true" data-class=""><?=$jatbi->lang("Nội dung")?></th>
                                    <th data-name="price" data-orderable="true" class="text-nowrap text-start" data-visible="true" data-class="fw-bold text-primary"><?=$jatbi->lang("Đơn giá")?></th>
                                    <th data-name="amount" data-orderable="false" class="text-nowrap " data-visible="true" data-class=""><?=$jatbi->lang("Số lượng")?></th>
                                    <th data-name="units" data-orderable="false" class="text-nowrap " data-visible="true" data-class=""><?=$jatbi->lang("Đơn vị")?></th>
                                    <th data-name="total" data-orderable="false" class="text-nowrap " data-visible="true" data-class="text-success fw-bold"><?=$jatbi->lang("Thành tiền")?></th>
                                    <th data-name="notes" data-orderable="false" class="text-nowrap " data-visible="true" data-class=""><?=$jatbi->lang("Ghi chú")?></th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th data-name="total"></th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <?php 
                $reply = false; 
                if(count($consultations)>0){ 
            ?>
            <div class="card bg-body shadow-lg border-0 bg-opacity-50 rounded-4 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-bold text-uppercase mb-3"><?=$jatbi->lang("Tham vấn")?></div>
                    </div>
                    <div class="">
                        <?php 
                            foreach($consultations as $getconsultation) { 
                            if($getconsultation['status']==0 && $account['id']==$getconsultation['account_consultation']){
                                $reply = true;
                            }
                            $user = $app->get("accounts","*",["id"=>$getconsultation['account']]);
                            $acc = $app->get("accounts","*",["id"=>$getconsultation['account_consultation']]);
                        ?>
                        <div class="mb-3">
                            <div class="d-flex align-items-start justify-content-between">
                                <div class="d-flex align-items-center">
                                    <img alt="<?=$user['name']?>" data-src="/<?=$user['avatar']?>?type=thumb" class="bg-body width height lazyload p-1 rounded-circle" style="--width:40px;--height:40px;">
                                    <div class="ms-2">
                                        <strong><?=$user['name']?></strong>
                                        <div class="small"><?=$jatbi->datetime($getconsultation['date'])?></div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <strong><?=$acc['name']?></strong>
                                        <?php if($getconsultation['status']==1){ ?>
                                        <div class="small"><?=$jatbi->datetime($getconsultation['date_reply'])?></div>
                                        <?php } ?>
                                    </div>
                                    <img alt="<?=$user['name']?>" data-src="/<?=$acc['avatar']?>?type=thumb" class="bg-body width height lazyload p-1 rounded-circle" style="--width:40px;--height:40px;">
                                </div>
                            </div>
                            <div class="bg-body mt-2 rounded-4 p-3 rounded-bottom-0">
                                <?=nl2br($getconsultation['content'])?>
                            </div>
                            <?php if($getconsultation['status']==1){ ?>
                            <div class="bg-success-subtle fw-bold text-body text-end rounded-4 p-3 rounded-top-0">
                                <?=$getconsultation['content_reply']?>
                            </div>
                            <?php } ?>
                        </div>
                        <?php } ?>
                    </div>
                </div>
            </div>
            <?php } ?>
            <div class="card bg-body shadow-lg border-0 bg-opacity-50 rounded-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-bold text-uppercase"><?=$jatbi->lang("Bình luận")?></div>
                        <div>
                            <button class="btn btn-sm btn-eclo py-1 rounded-pill fw-bold" data-action="modal" data-url="/proposal/comments-add/<?=$data['active']?>"><i class="ti ti-message-2 me-1"></i> Thêm bình luận</button>
                        </div>
                    </div>
                    <div class="">
                        <table id="datatable-comments" 
                            data-table 
                            class="table align-middle" 
                            data-type="POST" 
                            data-server="true" 
                            data-processing="true" 
                            data-page-length="10"
                            data-searching="true"
                            data-paging="true"
                            data-url="/proposal/comments/<?=$data['active']?>"
                            data-state-save='true'
                            style="width:100%">
                            <thead>
                                <tr>
                                    <th data-name="content" data-orderable="false" class="text-nowrap text-start" data-visible="true" data-class=""><?=$jatbi->lang("Bình luận")?></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <?php if(isset($cancels)){ ?>
                <div class="card bg-body shadow-lg border-0 bg-opacity-50 rounded-4 mb-4">
                    <div class="card-body">
                        <strong class="mb-3 d-block"><?=$jatbi->lang("Tiến trình hủy")?></strong>
                        <?php 
                            if(!empty($cancels) && is_array($cancels)){
                            foreach($cancels as $key => $proces) {
                                if (!is_array($proces)) {
                                    continue;
                                }
                                $node = $app->get("proposal_workflows_nodes","*",["id"=>$proces['node']]);
                                if($key==0){
                                     $user = $app->get("accounts",["name","avatar"],["id"=>$data['account_id'] ]) ?? ["avatar"=>'',"name"=>''];
                                }
                                if($proces['account']){
                                    $user = $app->get("accounts",["name","avatar"],["id"=>$proces['account'] ]) ?? ["avatar"=>'',"name"=>''];
                                }
                        ?>
                            <div class="d-flex justify-content-between align-items-center mb-1 border-bottom pb-2">
                                <div class="w-100">
                                    <div class="mt-2 d-flex justify-content-between align-items-center w-100">
                                        <div class="d-flex">
                                            <img data-src="/<?=$user['avatar']?>" class="lazyload width height rounded-2" style="--width:40px;--height:40px;">
                                            <div class="ms-2">
                                                <span class="badge " style="background: <?=$node['background']?>; color:<?=$node['color']?>;"><?=$node['name']?></span>
                                                <strong class="pt-1 d-block"><?=$user['name']?></strong>
                                            </div>
                                        </div>
                                        <div>
                                            <?php if($proces['approval']==1){ ?>
                                            <i class="ti ti-circle-check fs-2 text-success"></i>
                                            <?php } ?>
                                            <?php if($proces['approval']==2){ ?>
                                            <i class="ti ti-ban fs-2 text-danger"></i>
                                            <?php } ?>
                                            <?php if($proces['approval']==0){ ?>
                                                <div class="animate__animated animate__heartBeat animate__infinite">
                                                    <i class="ti ti-player-pause fs-2 text-danger"></i>
                                                </div>
                                            <?php } ?>
                                        </div>
                                    </div>
                                    <?php if($proces['approval']!=0){ ?>
                                        <div class="card border-0 p-2 rounded-4 mt-2">
                                            <span class="fst-italic"><?=$proces['approval_content']?></span>
                                            <small><?=$jatbi->datetime($proces['date'])?></small>
                                        </div>
                                    <?php } ?>
                                </div>
                            </div>
                        <?php } } ?>
                    </div>
                </div>
            <?php } ?>
            <div class="card bg-body shadow-lg border-0 bg-opacity-50 rounded-4 mb-4">
                <div class="card-body">
                    <strong class="mb-3 d-block"><?=$jatbi->lang("Tiến trình dề xuất")?></strong>
                    <?php 
                        if(!empty($process) && is_array($process)){
                        foreach($process as $key => $proces) {
                            if (!is_array($proces)) {
                                continue;
                            }
                            $getProcess = $app->get("proposal_process","*",["proposal"=>$data['id'],"node"=>$proces['node_id'],"deleted"=>0]);
                            $node = $app->get("proposal_workflows_nodes","*",["id"=>$proces['node_id']]);
                            if($key==0){
                                 $user = $app->get("accounts",["name","avatar"],["id"=>$data['account_id'] ]) ?? ["avatar"=>'',"name"=>''];
                            }
                            if($proces['approver_account_id']){
                                $user = $app->get("accounts",["name","avatar"],["id"=>$proces['approver_account_id'] ]) ?? ["avatar"=>'',"name"=>''];
                            }
                    ?>
                        <div class="d-flex justify-content-between align-items-center mb-1 border-bottom pb-2 <?=(!empty($getProcess) || $node_approval['node_id']==$proces['node_id'] && $data['status_id']!=3)?'':'opacity-50'?> ">
                            <div class="w-100">
                                <div class="mt-2 d-flex justify-content-between align-items-center w-100">
                                    <div class="d-flex">
                                        <img data-src="/<?=$user['avatar']?>" class="lazyload width height rounded-2" style="--width:40px;--height:40px;">
                                        <div class="ms-2">
                                            <span class="badge " style="background: <?=$node['background']?>; color:<?=$node['color']?>;"><?=$node['name']?></span>
                                            <strong class="pt-1 d-block"><?=$user['name']?></strong>
                                        </div>
                                    </div>
                                    <div>
                                        <?php if(!empty($getProcess)){ ?>
                                            <?php if($getProcess['approval']==1){ ?>
                                            <i class="ti ti-circle-check fs-2 text-success"></i>
                                            <?php } ?>
                                            <?php if($getProcess['approval']==2){ ?>
                                            <i class="ti ti-ban fs-2 text-danger"></i>
                                            <?php } ?>
                                        <?php } else { ?>
                                            <?php if(($node_approval['node_id'] ?? 0)==$proces['node_id'] && $data['status_id']!=3){ ?>
                                                <div class="animate__animated animate__heartBeat animate__infinite">
                                                    <i class="ti ti-player-pause fs-2 text-danger"></i>
                                                </div>
                                            <?php } else { ?>
                                                <i class="ti ti-circle-dashed fs-2 text-muted"></i>
                                            <?php } ?>
                                        <?php } ?>
                                    </div>
                                </div>
                                <?php if(!empty($getProcess)){ ?>
                                    <div class="card border-0 p-2 rounded-4 mt-2">
                                        <span class="fst-italic"><?=$getProcess['approval_content']?></span>
                                        <small><?=$jatbi->datetime($getProcess['date'])?></small>
                                    </div>
                                <?php } ?>
                            </div>
                        </div>
                    <?php } } ?>
                </div>
            </div>
            <div class="card bg-body shadow-lg border-0 bg-opacity-50 rounded-4 ">
                <div class="card-body">
                    <strong class="mb-3 d-block"><?=$jatbi->lang("Nhật ký")?></strong>
                    <?php foreach($proposals_logs as $key => $logs) {
                        $user = $app->get("accounts",["name","avatar"],["id"=>$logs['account'] ]) ?? ["avatar"=>'',"name"=>''];
                        
                    ?>
                        <div class="d-flex justify-content-between align-items-center mb-1 border-bottom pb-2 ">
                            <div class="w-100">
                                <div class="d-flex justify-content-between align-items-start w-100">
                                    <div class="d-flex align-items-start">
                                        <img data-src="/<?=$user['avatar']?>" class="lazyload width height rounded-2 mt-2" style="--width:30px;--height:30px;">
                                        <div class="ms-2">
                                            <strong class="pt-1 d-block"><?=$user['name']?></strong>
                                            <small><?=$jatbi->datetime($logs['date'])?></small>
                                        </div>
                                    </div>
                                </div>
                                <div class="card border-0 p-2 rounded-4 mt-2">
                                    <span class="fst-italic small"><?=$logs['content']?>: <?=$logs['notes'] ?? ''?></span>
                                </div>
                            </div>
                        </div>
                    <?php } ?>
                </div>
            </div>
        </div>
    </div>
    <?php if($active_approval==true){ ?>
    <div class="position-fixed bottom-0 start-0 w-100 bg-body py-2 pb-standalone">
        <div class="text-center text-md-right">
            <button class="btn btn-primary text-light fw-bold mx-1" data-load="this" data-action="modal" data-url="/proposal/consultation/<?=$data['active']?>">Tham vấn</button>
            <button class="btn btn-danger text-light fw-bold mx-1" data-load="this" data-action="modal" data-url="/proposal/approval/<?=$data['active']?>?type=2">Không duyệt</button>
            <button class="btn btn-success text-light fw-bold mx-1" data-load="this" data-action="modal" data-url="/proposal/approval/<?=$data['active']?>?type=1">Xác nhận</button>
        </div>
    </div>
    <?php } ?>
    <?php if($active_approval_cancel==true){ ?>
    <div class="position-fixed bottom-0 start-0 w-100 bg-body py-2 pb-standalone">
        <div class="text-center text-md-right">
            <button class="btn btn-danger text-light fw-bold mx-1" data-load="this" data-action="modal" data-url="/proposal/cancel-approval/<?=$data['active']?>?type=2">Không duyệt</button>
            <button class="btn btn-success text-light fw-bold mx-1" data-load="this" data-action="modal" data-url="/proposal/cancel-approval/<?=$data['active']?>?type=1">Xác nhận</button>
        </div>
    </div>
    <?php } ?>
    <?php if($edit_proposal==true){ ?>
    <div class="position-fixed bottom-0 start-0 w-100 bg-body py-2 pb-standalone">
        <div class="text-center text-md-right">
            <a class="btn btn-warning text-light fw-bold" data-pjax href="/proposal/edit/<?=$data['active']?>">Chỉnh sửa lại</a>
        </div>
    </div>
    <?php } ?>
    <?php if($reply==true){ ?>
    <div class="position-fixed bottom-0 start-0 w-100 bg-body py-2 pb-standalone">
        <div class="text-center text-md-right">
            <button data-action="modal" data-url="/proposal/consultation-reply/<?=$data['active']?>" class=" btn btn-info text-light fw-bold"><?=$jatbi->lang("Trả lời tham vấn")?></button>
        </div>
    </div>
    <?php } ?>
</div>