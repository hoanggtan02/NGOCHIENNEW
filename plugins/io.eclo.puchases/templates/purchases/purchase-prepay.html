<div class="modal fade modal-load" tabindex="-1">
    <div class="modal-dialog" style="max-width:70%">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">#
                    <?=htmlspecialchars($ballot_code['purchase'] ?? '')?>-
                    <?=htmlspecialchars($data['code'] ?? '')?>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="<?=$_SERVER['REQUEST_URI']?>">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <?=$app->component('input', [
                                "name"        => 'date',
                                "type"        => 'date',
                                "placeholder" => $jatbi->lang("Ngày"),
                                "label"       => $jatbi->lang("Ngày") . ' <small class="text-danger">*</small>',
                                "value"       => date("Y-m-d"),
                                "required"    => 'true',
                            ])?>

                            <?=$app->component('input', [
                                "name"        => 'price',
                                "type"        => 'text',
                                "placeholder" => $jatbi->lang("Số tiền"),
                                "label"       => $jatbi->lang("Số tiền") . ' <small class="text-danger">*</small>',
                                "value"       => '',
                                "class"       => 'number',
                                "required"    => 'true',
                            ])?>

                            <?=$app->component('select', [
                                "name"        => 'debt',
                                "label"       => $jatbi->lang("Tài khoản nợ") . ' <small class="text-danger">*</small>',
                                "placeholder" => $jatbi->lang("Tài khoản nợ"),
                                "selected"    => $data['debt'] ?? '',
                                "options"     => $accountants_options,
                                "class"       => 'select2',
                                "required"    => 'true',
                            ])?>

                            <?=$app->component('select', [
                                "name"        => 'has',
                                "label"       => $jatbi->lang("Tài khoản có") . ' <small class="text-danger">*</small>',
                                "placeholder" => $jatbi->lang("Tài khoản có"),
                                "selected"    => $data['has'] ?? '',
                                "options"     => $accountants_options,
                                "class"       => 'select2',
                                "required"    => 'true',
                            ])?>

                            <?=$app->component('textarea', [
                                "name"        => 'content',
                                "placeholder" => $jatbi->lang("Nội dung"),
                                "label"       => $jatbi->lang("Nội dung"),
                                "value"       => '#'.htmlspecialchars($ballot_code['purchase'] ?? '').'-'.htmlspecialchars($data['code'] ?? ''),
                                "rows"        => '4',
                            ])?>

                            <div class="mb-3 mt-3">
                                <button type="submit" class="btn btn-eclo w-100 py-3 rounded-pill fw-bold"
                                    data-action="submit" data-alert="true"
                                    data-load="this"><?=$jatbi->lang("Hoàn thành")?></button>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <td colspan="4"><strong><?=$jatbi->lang("Nhà cung cấp")?>:</strong>
                                                <?=htmlspecialchars($app->get("vendors", "name", ["id" => $data['vendor']]) ?? 'N/A')?>
                                            </td>
                                            <td colspan="3"><strong><?=$jatbi->lang("Điện thoại")?>:</strong>
                                                <?=htmlspecialchars($app->get("vendors", "phone", ["id" => $data['vendor']]) ?? 'N/A')?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="4"><strong><?=$jatbi->lang("Mã hóa đơn")?>:</strong> #
                                                <?=htmlspecialchars($ballot_code['purchase'] ?? '')?>-
                                                <?=htmlspecialchars($data['code'] ?? '')?>
                                            </td>
                                            <td colspan="3"><strong><?=$jatbi->lang("Ngày")?>:</strong>
                                                <?=$jatbi->datetime($data['date_poster'] ?? '')?></td>
                                        </tr>
                                        <tr>
                                            <td colspan="7"><strong><?=$jatbi->lang("Trạng thái")?>:</strong>
                                                <?=htmlspecialchars($Status_purchase[$data['status']]['name'] ?? 'Không rõ')?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="7"><strong><?=$jatbi->lang("Ghi chú")?>:</strong>
                                                <?=htmlspecialchars($data['notes'] ?? '')?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th width="4%"></th>
                                            <th><?=$jatbi->lang("Mã hàng")?></th>
                                            <th><?=$jatbi->lang("Tên")?></th>
                                            <th><?=$jatbi->lang("Số lượng")?></th>
                                            <th><?=$jatbi->lang("Đơn vị")?></th>
                                            <th><?=$jatbi->lang("Giá tiền")?></th>
                                            <th><?=$jatbi->lang("Thành tiền")?></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php foreach ($SelectProducts as $SelectProduct) {
                                            $getPro = $app->get("products", "*", ["id" => $SelectProduct['products']]);
                                            if ($getPro) {
                                                $price = ($SelectProduct['amount'] ?? 0) * ($SelectProduct['price'] ?? 0);
                                        ?>
                                        <tr>
                                            <td><img src="/<?=$upload['images']['products']['url'] . 'thumb/' . ($getPro['images'] ?? 'default.png')?>"
                                                    class="border border-light rounded shadow-sm w-100"></td>
                                            <td>
                                                <?=htmlspecialchars($getPro['code'] ?? '')?>
                                            </td>
                                            <td>
                                                <?=htmlspecialchars($getPro['name'] ?? '')?>
                                            </td>
                                            <td>
                                                <?=number_format($SelectProduct['amount'] ?? 0)?>
                                            </td>
                                            <td><?=htmlspecialchars($app->get("units", "name", ["id" => $getPro['units']]) ?? 'N/A')?>
                                            </td>
                                            <td>
                                                <?=number_format($SelectProduct['price'] ?? 0)?>
                                            </td>
                                            <td class="text-end fw-bold">
                                                <?=number_format($price)?>
                                            </td>
                                        </tr>
                                        <?php 
                                            }
                                        }
                                        ?>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="6" class="text-end fw-bold"><?=$jatbi->lang("Tổng tiền")?></td>
                                            <td class="text-end fw-bold text-primary">
                                                <?=number_format($data['total'] ?? 0)?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="6" class="text-end fw-bold"><?=$jatbi->lang("Giảm trừ")?></td>
                                            <td class="text-end fw-bold">
                                                <?=number_format($data['minus'] ?? 0)?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="6" class="text-end fw-bold"><?=$jatbi->lang("Giảm giá")?> (
                                                <?=htmlspecialchars($data['discount'] ?? 0)?>%)
                                            </td>
                                            <td class="text-end fw-bold">
                                                <?=number_format($data['discount_price'] ?? 0)?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="6" class="text-end fw-bold"><?=$jatbi->lang("Phụ thu")?></td>
                                            <td class="text-end fw-bold">
                                                <?=number_format($data['surcharge'] ?? 0)?>
                                            </td>
                                        </tr>

                                        <tr>
                                            <td colspan="6" class="text-end fw-bold">
                                                <?=$jatbi->lang("Yêu cầu trả trước")?></td>
                                            <td class="text-end fw-bold">
                                                <?=number_format($data['prepay_req'] ?? 0)?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="6" class="text-end fw-bold"><?=$jatbi->lang("Thanh toán")?>
                                            </td>
                                            <td class="text-end fw-bold text-success">
                                                <?=number_format($data['payments'] ?? 0)?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="6" class="text-end fw-bold"><?=$jatbi->lang("Đã thanh toán")?>
                                            </td>
                                            <td class="text-end fw-bold text-warning">
                                                <?=number_format($data['prepay'] ?? 0)?>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="6" class="text-end fw-bold"><?=$jatbi->lang("Còn lại")?></td>
                                            <td class="text-end fw-bold text-danger">
                                                <?=number_format(($data['payments'] ?? 0) - ($data['prepay'] ?? 0))?>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                                <div class="card">
                                    <div class="card-header"><?=$jatbi->lang("Lịch sử thanh toán")?></div>
                                    <div class="card-body">
                                        <table class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th><?=$jatbi->lang("Số phiếu")?></th>
                                                    <th><?=$jatbi->lang("Số tiền")?></th>
                                                    <th><?=$jatbi->lang("Nội dung")?></th>
                                                    <th><?=$jatbi->lang("Ngày")?></th>
                                                    <th><?=$jatbi->lang("Tài khoản")?></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <?php foreach ($details as $detail) { ?>
                                                <tr>
                                                    <td>#
                                                        <?=htmlspecialchars($detail['code'] ?? '')?>
                                                    </td>
                                                    <td>
                                                        <?=number_format($detail['price'] ?? 0)?>
                                                    </td>
                                                    <td>
                                                        <?=htmlspecialchars($detail['content'] ?? '')?>
                                                    </td>
                                                    <td><?=$jatbi->datetime($detail['date'] ?? '')?></td>
                                                    <td><?=htmlspecialchars($app->get("accounts", "name", ["id" => $detail['user']]) ?? 'N/A')?>
                                                    </td>
                                                </tr>
                                                <?php } ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal"><?=$jatbi->lang("Hủy")?></button>
                </div>
            </form>
        </div>
    </div>
</div>