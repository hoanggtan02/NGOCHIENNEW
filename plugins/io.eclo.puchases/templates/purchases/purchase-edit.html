<div class="container-fluid">
    <div class="mb-3">
        <h4 class="mb-0 fw-bold text-body">
            <?=$title?>
        </h4>
        <ul class="breadcrumb small mb-0">
            <li class="breadcrumb-item small"><a href="<?=$jatbi->url('/')?>"
                    class="pjax-load link-secondary"><?=$jatbi->lang("Trang chủ")?></a></li>
            <li class="breadcrumb-item small"><a href="<?=$jatbi->url('/purchases/purchase')?>"
                    class="pjax-load link-secondary"><?=$jatbi->lang("Đề xuất mua hàng")?></a></li>
            <li class="breadcrumb-item small text-body" aria-current="page">
                <?=$title?>
            </li>
        </ul>
    </div>

    <div class="card bg-body bg-opacity-50 shadow border-0 rounded-4 ms-5 me-5 mb-5">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6 col-lg-3">
                    <?=$app->component('select', [
                        'name' => 'type', 
                        'placeholder' => $jatbi->lang("Loại đề xuất"), 
                        'required' => true,
                        'options' => $type, 
                        'selected' => $_SESSION['purchase'][$action]['type'] ?? '', 
                        'class' => 'change-update', 
                        'attr' => 'data-action="change" data-load="this" 
                                    data-url="/purchases/purchase-update/edit/type" 
                                    data-form=\'{"value": "this.val"}\''
                    ])?>
                </div>
                <div class="col-md-6 col-lg-3">
                    <?=$app->component('select',[
                        "name"=>'vendor', 
                        "placeholder"=>$jatbi->lang("Nhà cung cấp"), 
                        'required' => true,
                        'options' => $vendors, 
                        'selected' => $getCus['id'] ?? '', 
                        'attr' => 'data-action="change" data-load="this" 
                                    data-url="/purchases/purchase-update/edit/vendor" 
                                    data-form=\'{"value": "this.val"}\''
                    ])?>
                </div>
                <div class="col-md-6 col-lg-3">
                    <?=$app->component('select',[
                        "name"=>'stores', 
                        "placeholder"=>$jatbi->lang("Cửa hàng"), 
                        'required' => true,
                        'options' => $storess, 
                        'selected' => $_SESSION['purchase'][$action]['stores']['id'] ?? '', 
                        'attr' => 'data-action="change" data-load="this" 
                                    data-url="/purchases/purchase-update/edit/stores" 
                                    data-form=\'{"value": "this.val"}\''
                    ])?>
                </div>
                <div class="col-md-6 col-lg-3">
                    <?=$app->component('input', [
                        'type' => 'date', 'name' => 'date', 'placeholder' => $jatbi->lang("Ngày"), 'required' => true,
                        'value' => $data['date'] ?? date('Y-m-d'),
                        'attr' => 'data-action="blur" data-load="this" data-url="/purchases/purchase-update/edit/date" 
                                    data-form=\'{"value": "this.val"}\' '
                    ])?>
                </div>
                <div class="col-lg-4">
                    <?=$app->component('select',[
                        "name"=>'form',
                        "placeholder"=>$jatbi->lang("Hình thức"),
                        "selected" => $_SESSION['purchase'][$action]['form'] ?? 0, 
                        "attr" => 'data-width="100%" data-select-load="true" data-select-url="/api/search/form-type-3" data-method="POST" data-keyword="keyword"
                                    data-action="change" data-url="/purchases/purchase-update/edit/form" data-form=\'{"value": "this.val"}\'',
                        "id" => "form",
                        "options" => $forms ?? [],
                        "required" => 'true',
                    ])?>
                </div>
                <div class="col-lg-4">
                    <?=$app->component('select',[
                        "name"=>'workflows',
                        "placeholder"=>$jatbi->lang("Quy trình"),
                        "selected" => $_SESSION['purchase'][$action]['workflows'] ?? 0,
                        "attr" => 'data-width="100%" data-select-load="true"  data-parent="#form" data-select-url="/proposal/search/workflows" data-method="POST" data-keyword="keyword"
                                    data-action="change" data-url="/purchases/purchase-update/edit/workflows" data-form=\'{"value": "this.val"}\'',
                        "id" => "workflows",
                        "options" => $workflows ?? [],
                        "required" => 'true',
                    ])?>
                </div>

                <div class="col-lg-4">
                    <?=$app->component('select',[
                        "name"=>'category',
                        "placeholder"=>$jatbi->lang("Hạng mục"),
                        "selected" => $_SESSION['purchase'][$action]['category'] ?? 0,
                        "attr" => 'data-width="100%" data-select-load="true"  data-parent="#workflows" data-select-url="/proposal/search/categorys" data-method="POST" data-keyword="keyword"
                                    data-action="change" data-url="/purchases/purchase-update/edit/category" data-form=\'{"value": "this.val"}\'',
                        "id" => "category",
                        "options" => $categorys ?? [],
                        "required" => 'true',
                    ])?>
                </div>
            </div>
            <?php if($data['type']==1){?>
            <div class="mb-3">
                <div class="bg-body rounded-pill p-2 d-flex justify-content-center align-items-center" data-pos-table>
                    <i class="ti ti-search fs-3 ms-2"></i>
                    <div class="w-100" data-search="true" data-url="/api/products-search-purchase-edit">
                        <input type="text"
                            class="form-control bg-transparent border-0 shadow-none py-3 w-100"
                            placeholder="Tìm kiếm">
                        <div class="search-results-box rounded-4 shadow bg-body border-0 position-absolute max-height scroll-y w-100 z-3"
                            style="--max-height:300px;"></div>
                        <template class="search-item-template">
                            <div class="search-item border-0 py-2 btn text-start position-relative"
                                style="display: flex; align-items: center; gap: 10px;">
                                <div data-attr-products="value">
                                    <strong data-name="text"></strong><br>
                                    <a data-action="click" data-load="this"
                                        data-selector="[data-pos-table]"
                                        data-attr-url="url" class="stretched-link" href="#!"></a>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <?php }else{ ?>
            <div class="md-3">
                <?=$app->component('select',[
                    "name"=>'ingredient', 
                    "placeholder"=>$jatbi->lang("Sản phẩm"), 
                    'required' => true,
                    'options' => $ingredient, 
                    'attr' => 'data-action="change" data-load="this" data-selector="[data-pos-table]"
                                data-url="/purchases/purchase-update/edit/ingredient/add" 
                                data-form=\'{"value": "this.val"}\''
                ])?>
            </div>
            <?php } ?>
            <div class="table-responsive mt-3" data-pos-table>
                <table class="table align-middle">
                    <thead>
                        <?php if($data['type']==1){?>
                        <tr>
                            <!-- <th class="text-center" width="4%"></th> -->
                            <th class="text-center"><?=$jatbi->lang('Sản phẩm')?></th>
                            <th class="text-center" ><?=$jatbi->lang('Số lượng')?></th>
                            <th class="text-center"><?=$jatbi->lang('Đơn vị')?></th>
                            <th class="text-center"><?=$jatbi->lang('Nhà cung cấp')?></th>
                            <th class="text-center"><?=$jatbi->lang('Đơn giá')?></th>
                            <th class="text-center"><?=$jatbi->lang('Thành tiền')?></th>
                            <th></th>
                        </tr>
                        <?php }else{?>
                            <th class="text-center"><?=$jatbi->lang('Loại')?></th>
                            <th class="text-center"><?=$jatbi->lang('Mã nguyên liệu')?></th>
                            <th class="text-center" ><?=$jatbi->lang('Số lượng')?></th>
                            <th class="text-center"><?=$jatbi->lang('Đơn vị')?></th>
                            <th class="text-center"><?=$jatbi->lang('Đơn giá')?></th>
                            <th class="text-center"><?=$jatbi->lang('Thành tiền')?></th>
                            <th></th>
                        <?php }?>
                    </thead>
                    <tbody>
                        <?php if($data['type']==1){
                            $total = 0;
                            $total_price = 0;
                            foreach (($SelectProducts ?? []) as $key => $SelectProduct) {
                                $getPro = $app->get("products","*",["id"=>$SelectProduct['products']]); 
                                $total_price = $SelectProduct['amount']*$SelectProduct['price'];
                                $total += $total_price;								 										
                        ?>
                        <tr>
                            <td>
                                <?=$getPro['name'] ?? ""?>
                            </td>
                            <td>
                                <input type="tel" data-number="money" data-currency="" data-decimals="0"
                                    data-thousands="," data-decimal="." class="form-control form-control-sm text-end"
                                    value="<?=$SelectProduct['amount'] ?? ''?>"
                                    data-url="/purchases/purchase-update/edit/products/amount/<?=$key?>"
                                    data-form='{"value": "this.val"}' data-action="blur" data-load="this">
                            </td>
                            <td>
                                <?=$app->get("units","name",["id"=>$getPro['units'] ?? ""])?>
                            </td>
                            <td>
                                <?=$app->get("vendors","name",["id"=>$getPro['vendor'] ?? ""])?>
                            </td>
                            <td>
                                <input type="tel" data-number="money" data-currency="" data-decimals="0"
                                    data-thousands="," data-decimal="." class="form-control form-control-sm text-end"
                                    value="<?=$SelectProduct['price'] ?? 0?>"
                                    data-url="/purchases/purchase-update/edit/products/price/<?=$key?>"
                                    data-form='{"value": "this.val"}' data-action="blur" data-load="this">
                            </td>

                            <td class="text-end">
                                <?=number_format($total_price)?>
                            </td>

                            <td class="text-center"><a class="click-update text-danger" role="button"
                                    data-action="click" data-load="this"
                                    data-url="/purchases/purchase-update/edit/products/deleted/<?=$key?>"><i
                                        class="ti ti-trash fs-5"></i></a>
                            </td>
                        </tr>
                        <?php } ?>
                        <?php }else{
                            $to = 0;
                            $total_pri = 0;
                            foreach (($SelectIngredients ?? []) as $key => $SelectIngredient) {
                                $ging = $app->get("ingredient","*",["id"=>$SelectIngredient['ingredient']  ?? ""]);
                                $total_pri = $SelectIngredient['amount']*$SelectIngredient['price'];
                                $to += $total_pri;
                        ?> 
                        <tr>
                            <?php if($ging['type']==1){?>
                            <td><?=$jatbi->lang("Đai")?></td>	
                            <?php } ?>
                            <?php if($ging['type']==2){?>
                            <td><?=$jatbi->lang("Ngọc")?></td>	
                            <?php } ?>
                            <?php if($ging['type']==3){?>
                            <td>Khác</td>	
                            <?php } ?>								
                            <td class="p-1">
                                <?=$ging['code']?>
                            </td>
                            <td>
                                <input type="tel" data-number="money" data-currency="" data-decimals="1"
                                    data-thousands="," data-decimal="." class="form-control form-control-sm text-end"
                                    value="<?=$SelectIngredient['amount'] ?? ''?>"
                                    data-url="/purchases/purchase-update/edit/ingredient/amount/<?=$key?>"
                                    data-form='{"value": "this.val"}' data-action="blur" data-load="this">
                            </td>
                            <td class="p-1">
                                <?=$app->get("units","name",["id"=>$ging['units'] ?? ""])?>
                            </td>
                            <td>
                                <input type="tel" data-number="money" data-currency="" data-decimals="0"
                                    data-thousands="," data-decimal="." class="form-control form-control-sm text-end"
                                    value="<?=$SelectIngredient['price'] ?? 0?>"
                                    data-url="/purchases/purchase-update/edit/ingredient/price/<?=$key?>"
                                    data-form='{"value": "this.val"}' data-action="blur" data-load="this">
                            </td>
                            <td class="text-end">
                                <?=number_format($total_pri)?>
                            </td>
                            <td class="text-center"><a class="click-update text-danger" role="button"
                                    data-action="click" data-load="this"
                                    data-url="/purchases/purchase-update/edit/ingredient/deleted/<?=$key?>"><i
                                        class="ti ti-trash fs-5"></i></a>
                            </td>
                        </tr>
                            <?php } ?>
                        <?php } ?>
                    </tbody>
                    <tfoot>
                    <?php if($data['type']==1){ ?>
                        <tr>
                            <td colspan="5" class="text-end"><?=$jatbi->lang('Tổng tiền')?></td>
                            <td class="text-end text-primary"><?=number_format($total)?></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end "><?=$jatbi->lang('Giảm trừ')?></td>
                            <td class="text-end">
                                <?php 
                                $minu = 0;
                                foreach (($_SESSION['purchase'][$action]['minus'] ?? [])  as $minus) {
                                    $minu += (float)$minus['price'];}?>
                                <?=number_format($minu)?>
                            </td>
                            <td class="text-center"><a class="click-update text-danger" role="button"
                                    data-action="modal" data-load="this"
                                    data-url="/purchases/purchase-update/edit/details/minus"><i
                                        class="ti ti-plus fs-5"></i></a>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end">
                                <?=$jatbi->lang('Giảm giá')?>
                                <?php $discount = (float)($data['discount'] ?? 0) * (float)($total ?? 0) / 100; ?>
                                <?=number_format($discount)?>
                            </td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <input type="tel" 
                                        data-number="money" data-currency="" data-decimals="0"
                                        data-thousands="," data-decimal="." 
                                        class="form-control text-end"
                                        value="<?= $data['discount'] ?? 0 ?>"
                                        data-url="/purchases/purchase-update/edit/discount"
                                        data-form='{"value": "this.val"}' data-action="blur" data-load="this">
                                    <span class="input-group-text"><i class="ti ti-percentage"></i></span>
                                </div>
                            </td>
                            <td class="text-center"></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end"><?=$jatbi->lang('Phụ thu')?></td>
                            <td class="text-end">
                                <?php 
                                $surcharge = 0;
                                foreach (($_SESSION['purchase'][$action]['surcharge'] ?? []) as $surcharges) {
                                    $surcharge += $surcharges['price'];
                                }?>
                                <?=number_format($surcharge)?>
                            </td>
                            <td class="text-center"><a class="click-update text-danger" role="button"
                                    data-action="modal" data-load="this"
                                    data-url="/purchases/purchase-update/edit/details/surcharge"><i
                                        class="ti ti-plus fs-5"></i></a>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end"><?=$jatbi->lang('Thanh toán')?></td>
                            <td class="text-end text-success">
                                <?php $payment = (($total-$minu-$discount)+$surcharge)?>
                                <?=number_format($payment)?>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end "><?=$jatbi->lang('Yêu cầu trả trước')?></td>
                            <td class="text-end text-warning">
                                <?php 
                                $prepay_req = 0;
                                foreach (($_SESSION['purchase'][$action]['prepay_req'] ?? []) as $prepays) {
                                    $prepay_req += $prepays['price'];
                                }?>
                                <?=number_format($prepay_req)?>
                            </td>
                            <td class="text-center"><a class="click-update text-danger" role="button"
                                    data-action="modal" data-load="this"
                                    data-url="/purchases/purchase-update/edit/details/prepay_req"><i
                                        class="ti ti-plus fs-5"></i></a>
                            </td>
                    <?php }else{ ?>
                        <tr>
                            <td colspan="5" class="text-end"><?=$jatbi->lang('Tổng tiền')?></td>
                            <td class="text-end text-primary"><?=number_format($to)?></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end "><?=$jatbi->lang('Giảm trừ')?></td>
                            <td class="text-end">
                                <?php 
                                $minu = 0;
                                foreach (($_SESSION['purchase'][$action]['minus'] ?? []) as $minus) {
                                    $minu += (float)$minus['price'];
                                }?>
                                <?=number_format($minu)?>
                            </td>
                            <td class="text-center"><a class="click-update text-danger" role="button"
                                    data-action="modal" data-load="this"
                                    data-url="/purchases/purchase-update/edit/details/minus"><i
                                        class="ti ti-plus fs-5"></i></a>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end ">
                                <?=$jatbi->lang('Giảm giá')?>
                                <?php $discount = (($data['discount'] ?? 0)*$to/100); ?>
                                <?=number_format($discount)?>
                            </td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <input type="tel" data-number="money" data-currency="" data-decimals="0"
                                        data-thousands="," data-decimal="." class="form-control form-control-sm text-end"
                                        value="<?=$data['discount'] ?? 0?>"
                                        data-url="/purchases/purchase-update/edit/discount"
                                        data-form='{"value": "this.val"}' data-action="blur" data-load="this">
                                    <span class="input-group-text"><i class="ti ti-percentage"></i></span>
                                </div>
                            </td>
                            <td class="text-center"></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end"><?=$jatbi->lang('Phụ thu')?></td>
                            <td class="text-end">
                                <?php 
                                $surcharge = 0;
                                foreach (($_SESSION['purchase'][$action]['surcharge'] ?? []) as $surcharges) {
                                    $surcharge += $surcharges['price'];
                                }?>
                                <?=number_format($surcharge)?>
                            </td>
                            <td class="text-center"><a class="click-update text-danger" role="button"
                                    data-action="modal" data-load="this"
                                    data-url="/purchases/purchase-update/edit/details/surcharge"><i
                                        class="ti ti-plus fs-5"></i></a>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end"><?=$jatbi->lang('Thanh toán')?></td>
                            <td class="text-end text-success">
                                <?php $payment = (($to-$minu-$discount)+$surcharge)?>
                                <?=number_format($payment)?>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-end "><?=$jatbi->lang('Yêu cầu trả trước')?></td>
                            <td class="text-end text-warning">
                                <?php 
                                $prepay_req = 0;
                                foreach (($_SESSION['purchase'][$action]['prepay_req'] ?? []) as $prepays) {
                                    $prepay_req += $prepays['price'];
                                }?>
                                <?=number_format($prepay_req)?>
                            </td>
                            <td class="text-center"><a class="click-update text-danger" role="button"
                                    data-action="modal" data-load="this"
                                    data-url="/purchases/purchase-update/edit/details/prepay_req"><i
                                        class="ti ti-plus fs-5"></i></a>
                            </td>
                        </tr>
                        <?php } ?>
                    </tfoot>
                </table>
            </div>

            <div class="mt-3">
                <?=$app->component('textarea', [
                    "name" => 'content', 
                    "placeholder" => "Nội dung", 
                    "value" => $data['content'] ?? '', 
                    "required" => 'true',
                    "attr" => 'data-action="blur" data-load="this" 
                                data-url="/purchases/purchase-update/edit/content" 
                                data-form=\'{"value": "this.val"}\''
                ])?>
            </div>
        </div>

        <div class="card-footer bg-transparent border-0 py-3 text-end">
            <button class="btn btn-light rounded-pill px-4 click-update" data-action="modal"
                data-url="/purchases/purchase-update/edit/cancel"><?=$jatbi->lang('Hủy')?></button>
            <button class="btn btn-eclo rounded-pill px-5 click-update" data-action="modal"
                data-load="/purchases/purchase"
                data-url="/purchases/purchase-update/edit/completed"><?=$jatbi->lang('Hoàn tất')?></button>
        </div>
    </div>
</div>