<div class="container" data-pos-this>
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0 fw-bold text-body">
                <?=$title?>
            </h4>
            <ul class="breadcrumb small mb-0">
                <li class="breadcrumb-item small">
                    <a href="<?=$jatbi->url('/')?>" data-pjax class="link-secondary"><?=$jatbi->lang("Trang chủ")?></a>
                </li>
                <li class="breadcrumb-item small text-body" aria-current="page">
                    <?=$jatbi->lang("Kế toán")?>
                </li>
                <li class="breadcrumb-item small text-body" aria-current="page">
                    <?=$title?>
                </li>
            </ul>
        </div>
    </div>
    <div class="row g-2">
        <div class="col-lg-12">
            <div class="bg-body rounded-pill p-2 d-flex justify-content-center align-items-center" data-pos-table>
                <i class="ti ti-search fs-3 ms-2"></i>
                <div class="w-100" data-search="true" data-url="/api/product-search/<?=$action?>">
                    <input type="text" class="form-control bg-transparent border-0 shadow-none py-3 w-100"
                        placeholder="Tìm kiếm">
                    <div class="search-results-box rounded-4 shadow bg-body border-0 position-absolute max-height scroll-y w-100 z-3"
                        style="--max-height:300px;"></div>
                    <template class="search-item-template">
                        <div class="search-item border-0 py-2 btn text-start position-relative"
                            style="display: flex; align-items: center; gap: 10px;">
                            <div data-attr-products="value">
                                <strong data-name="text"></strong><br>
                                <div class="d-flex">
                                    <div class="me-2">Số lượng: <small data-name="amount"></small></div>
                                    <div class="me-2">Quầy: <small data-name="brands"></small></div>
                                </div>
                                <a data-action="click" data-load="this" data-selector="[data-pos-table]"
                                    data-attr-url="url-3" class="stretched-link" href="#!"></a>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped table-bordered align-middle">
                            <thead>
                                <tr>
                                    <th width="20%">sản phẩm</th>
                                    <th width="10%">Đơn vị</th>
                                    <th width="10%" class="text-center">Số lượng</th>
                                    <th width="10%" class="text-end">Đơn giá</th>
                                    <th width="10%" class="text-end">Thành tiền</th>
                                    <th width="10%" class="text-center">Quẩy hàng</th>
                                    <th width="1%"></th>
                                    <th width="1%"></th>
                                </tr>
                            </thead>
                            <tbody data-pos-table>
                                <?php 
                                $total_price = 0;
                                $total_amount = 0;
                                $total = 0;
                                foreach (($GetInvoice_products ?? []) as $key => $SelectProduct) {
                                    $getPro = $app->get("products",['id','code','name'],["id"=>$SelectProduct['products'] ?? null ]); 
                                    $products_details = $app->select("products_details","*",["products"=>$getPro['id'] ?? null ]); 
                                    $total_price = ((float)($SelectProduct['amount'] ?? 0) * (float)($SelectProduct['price'] ?? 0));
                                    $total_amount += (float)($SelectProduct['amount'] ?? 0);
                                    $total += (float)($total_price ?? 0);
                                ?>
                                <tr>
                                    <td class="p-2">
                                        <?=$getPro['code'] ?? "" ?> -
                                        <?=$getPro['name'] ?? "" ?>
                                    </td>
                                    <td class="p-2">
                                        <?=$app->get("units","name",["id"=>$getPro['units'] ?? null ])?>
                                    </td>
                                    <td class="p-2">
                                        <input disabled type="number" name="amount" class="form-control"
                                            value="<?=$SelectProduct['amount'] ?? 0 ?>" data-load="true" min="0">

                                    </td>
                                    <td class="p-2 text-end">
                                        <?=number_format($SelectProduct['price'] ?? 0 )?>
                                        <?php if (($SelectProduct['price'] ?? 0) != ($SelectProduct['price_old'] ?? 0)) : ?>
                                        <p class="mb-0 text-decoration-line-through small">
                                            <?= number_format((float)($SelectProduct['price_old'] ?? 0)) ?>
                                        </p>
                                        <?php endif; ?>
                                    </td>
                                    <td class="p-2 text-end fw-bold">
                                        <?=number_format($total_price ?? 0 )?>
                                    </td>
                                    <td class="p-2 text-center fw-bold">
                                        <?=$app->get("branch","name",["id"=>$getPro['branch'] ?? null])?>
                                    </td>
                                    <td class="text-center">
                                        <a class="click-update text-danger" data-load="this" data-action="modal"
                                            data-alert="true" data-selector="[data-pos-table]"
                                            data-url="/accountants/acountant-invoice-edit/<?=$SelectProduct['id']?>">
                                            <i class="ti ti-edit"></i>
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <a class="click-update text-danger" data-load="this" data-action="modal"
                                            data-alert="true" data-selector="[data-pos-table]"
                                            data-url="/accountants/acountant-invoice-delete/<?=$SelectProduct['id']?>">
                                            <i class="ti ti-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="7"></td>
                                </tr>
                                <?php } ?>
                                <?php 
                                $total_price = 0;
                                $total = 0;
                                $total_amount = 0;
                                foreach (($datas['products'] ?? []) as $key => $value) { 												
                                    $products_detail = $app->select("products_details","*",["products"=>$value['id'] ?? null ]); 
                                    $total_price = ((float)($value['amount'] ?? 0)*(float)($value['price'] ?? 0));
                                    $total_amount += (float)($value['amount'] ?? 0);
                                    $total += (float)($total_price ?? 0); 
                                ?>
                                <tr>
                                    <td class="p-2">
                                        <span class="fw-bold">
                                            <?=$value['code']?> -
                                            <?=$value['name']?>
                                        </span>
                                        <div class="small mb-3">
                                            <?php foreach (($products_detail ?? []) as $details) {?>
                                            <?php if (($details['type'] ?? null) == 1){ ?>
                                            <p class="mb-0">
                                                <?=$jatbi->lang('Đai')?>:
                                                <?=$app->get("categorys","name",["id"=>$details['categorys'] ?? null ])?>
                                                -
                                                <?=$app->get("products_group","name",["id"=>$details['group'] ?? null ])?>
                                            </p>
                                            <?php } ?>
                                            <?php if (($details['type'] ?? null) == 2){ ?>
                                            <p class="mb-0">
                                                <?=$jatbi->lang('Ngọc')?>:
                                                <?=$app->get("pearl","name",["id"=>$details['pearl'] ?? null ])?> -
                                                <?=$app->get("sizes","name",["id"=>$details['sizes'] ?? null ])?> -
                                                <?=$app->get("colors","name",["id"=>$details['colors'] ?? null ])?>
                                            </p>
                                            <?php } ?>
                                            <?php } ?>
                                        </div>
                                    </td>
                                    <td class="p-2">
                                        <?=$app->get("units","name",["id"=>$value['units'] ?? null ])?>
                                    </td>
                                    <td class="p-2">
                                        <input type="number" name="amount" class="blur-update form-control"
                                            data-url="/accountants/invoices-update/update-acountant-invoice/<?=$action?>/products/amount/<?=$key?>"
                                            value="<?=$value['amount'] ?? 0 ?>" data-load="this" data-action="blur"
                                            data-form='{"value": "this.val"}' data-selector="[data-pos-table]" min="0">
                                    </td>
                                    <td class="p-2 text-end">
                                        <a href="#" class="modal-url" data-action="modal"
                                            data-selector="[data-pos-table]" data-load="this"
                                            data-url="/accountants/invoices-update/update-acountant-invoice/<?=$action?>/products-details/<?=$key?>/0">
                                            <?=number_format($value['price'] ?? 0 )?>
                                        </a>
                                        <?php if (($value['price'] ?? null) != ($value['price_old'] ?? null)){ ?>
                                        <p class="mb-0 text-decoration-line-through small">
                                            <?=number_format($value['price_old'] ?? 0 )?>
                                        </p>
                                        <?php } ?>
                                    </td>
                                    <td class="p-2 text-end fw-bold">
                                        <?=number_format($total_price ?? 0 )?>
                                    </td>
                                    <td class="p-2 text-center fw-bold">
                                        <?=$app->get("branch","name",["id"=>$getPro['branch'] ?? null])?>
                                    </td>
                                    <td class="text-center">
                                        <a class="click-update text-danger" data-load="this" data-action="click"
                                            data-alert="true" data-selector="[data-pos-table]"
                                            data-url="/accountants/invoices-update/update-acountant-invoice/<?=$action?>/products/deleted/<?=$key?>">
                                            <i class="ti ti-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                <?php } ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-end bg-light border-0">
                    <a class="btn btn-eclo-light py-3 rounded-4 me-2" data-load="this" data-action="modal"
                        data-url="/accountants/invoices-update/update-acountant-invoice/<?=$action?>/cancel/0/0">Hủy</a>
                    <a class="btn btn-danger py-3 rounded-4 me-2" data-load="this" data-action="modal" data-alert="true"
                        data-url="/accountants/accountant-invoices/update-acountant-invoice/<?=$action?>/completed/<?=$data['invoice']?>">Hoàn
                        tất</a>
                </div>
            </div>
        </div>
    </div>
</div>